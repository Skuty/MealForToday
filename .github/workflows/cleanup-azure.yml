name: Cleanup Azure Environments

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - staging
      pr_number:
        description: 'PR number (optional - will auto-detect from branch)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Detect PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            // Check if PR number was provided as input
            const inputPrNumber = '${{ inputs.pr_number }}';
            if (inputPrNumber) {
              console.log(`Using provided PR number: ${inputPrNumber}`);
              return inputPrNumber;
            }
            
            // Auto-detect PR number from branch
            const branch = '${{ github.ref_name }}';
            console.log(`Detecting PR for branch: ${branch}`);
            
            try {
              const { data: pulls } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${branch}`
              });
              
              if (pulls.length > 0) {
                const prNumber = pulls[0].number;
                console.log(`Found PR #${prNumber} for branch ${branch}`);
                return prNumber.toString();
              } else {
                console.log(`No open PR found for branch ${branch}`);
                return '';
              }
            } catch (error) {
              console.error('Error detecting PR:', error);
              return '';
            }
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Set cleanup variables
        id: vars
        run: |
          RESOURCE_GROUP="MealForToday"
          
          echo "resource_group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
      
      - name: List and Delete All Container Apps
        id: cleanup
        run: |
          RESOURCE_GROUP="${{ steps.vars.outputs.resource_group }}"
          
          # Check if resource group exists
          if ! az group show --name $RESOURCE_GROUP &> /dev/null; then
            echo "Resource group not found: $RESOURCE_GROUP"
            echo "deleted_count=0" >> $GITHUB_OUTPUT
            echo "deleted_apps=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # List all container apps in the resource group
          CONTAINER_APPS=$(az containerapp list \
            --resource-group $RESOURCE_GROUP \
            --query "[].name" \
            --output tsv)
          
          if [ -z "$CONTAINER_APPS" ]; then
            echo "No container apps found in resource group: $RESOURCE_GROUP"
            echo "deleted_count=0" >> $GITHUB_OUTPUT
            echo "deleted_apps=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Delete each container app
          DELETED_APPS=""
          COUNT=0
          while IFS= read -r APP_NAME; do
            if [ -n "$APP_NAME" ]; then
              echo "Deleting container app: $APP_NAME"
              az containerapp delete \
                --name "$APP_NAME" \
                --resource-group $RESOURCE_GROUP \
                --yes
              
              if [ $COUNT -eq 0 ]; then
                DELETED_APPS="$APP_NAME"
              else
                DELETED_APPS="$DELETED_APPS, $APP_NAME"
              fi
              COUNT=$((COUNT + 1))
            fi
          done <<< "$CONTAINER_APPS"
          
          echo "Successfully deleted $COUNT container app(s)"
          echo "deleted_count=$COUNT" >> $GITHUB_OUTPUT
          echo "deleted_apps=$DELETED_APPS" >> $GITHUB_OUTPUT
      
      - name: Generate cleanup summary
        run: |
          echo "## ðŸ§¹ Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Cleanup successful" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** \`${{ steps.vars.outputs.resource_group }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deleted Container Apps:** ${{ steps.cleanup.outputs.deleted_count }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.cleanup.outputs.deleted_count }}" != "0" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Apps Removed:**" >> $GITHUB_STEP_SUMMARY
            echo "\`${{ steps.cleanup.outputs.deleted_apps }}\`" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Comment on PR with cleanup status
        if: steps.pr.outputs.result != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.pr.outputs.result }}';
            const deletedCount = '${{ steps.cleanup.outputs.deleted_count }}';
            const deletedApps = '${{ steps.cleanup.outputs.deleted_apps }}';
            
            // Validate PR number exists and is valid before attempting to comment
            if (!prNumber || prNumber.trim() === '') {
              console.log('No PR number found, skipping comment');
              return;
            }
            
            const prNumberInt = parseInt(prNumber, 10);
            if (isNaN(prNumberInt)) {
              console.log('Invalid PR number, skipping comment');
              return;
            }
            
            let message = `## ðŸ§¹ Cleanup Complete\n\n` +
                         `âœ… Successfully cleaned up Azure Container Apps.\n\n` +
                         `**Environment:** ${{ inputs.environment }}\n` +
                         `**Deleted Container Apps:** ${deletedCount}\n`;
            
            if (deletedCount !== '0') {
              message += `\n**Apps Removed:** \`${deletedApps}\`\n`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumberInt,
              body: message
            });
