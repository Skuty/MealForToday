@page "/meals"
@rendermode InteractiveServer
@using MealForToday.Application.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject MealForToday.Application.Services.IMealService MealService
@inject MealForToday.Application.Services.IIngredientService IngredientService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISnackbar Snackbar

<PageTitle>Meals</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" GutterBottom="true">Meals Management</MudText>
    <MudText Typo="Typo.body1" Class="mb-4">Create and manage your meal recipes</MudText>

    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h5" GutterBottom="true">
            @(editingMeal == null ? "Create New Meal" : "Edit Meal")
        </MudText>
        
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="mealName" 
                              Label="Name" 
                              Required="true"
                              Placeholder="e.g., Spaghetti Bolognese"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="mealCuisineType" 
                              Label="Cuisine Type" 
                              Placeholder="e.g., Italian, Chinese, American"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="mealDescription" 
                              Label="Description" 
                              Lines="2"
                              Placeholder="Brief description of the meal"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.h6" GutterBottom="true">Ingredients</MudText>
        
        @if (mealIngredients.Any())
        {
            <MudTable Items="@mealIngredients" 
                      Dense="true" 
                      Hover="true" 
                      Class="mb-3"
                      Elevation="0">
                <HeaderContent>
                    <MudTh>Ingredient</MudTh>
                    <MudTh>Quantity</MudTh>
                    <MudTh>Unit</MudTh>
                    <MudTh>Notes</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    @{
                        var ingredient = context;
                    }
                    <MudTd DataLabel="Ingredient">@ingredient.IngredientName</MudTd>
                    <MudTd DataLabel="Quantity">@ingredient.Quantity</MudTd>
                    <MudTd DataLabel="Unit">@ingredient.Unit</MudTd>
                    <MudTd DataLabel="Notes">@ingredient.Notes</MudTd>
                    <MudTd>
                        <MudTooltip Text="Remove">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                          Color="Color.Error" 
                                          Size="Size.Small"
                                          OnClick="@(() => RemoveMealIngredient(ingredient))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudAlert Severity="Severity.Normal" Class="mb-3">No ingredients added yet. Add ingredients below.</MudAlert>
        }
        
        <MudPaper Class="pa-3" Outlined="true">
            <MudText Typo="Typo.subtitle2" Class="mb-2">Add Ingredient</MudText>
            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudSelect @bind-Value="selectedIngredientId" 
                               Label="Ingredient" 
                               Required="true"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense">
                        <MudSelectItem Value="@("")">Select ingredient...</MudSelectItem>
                        @if (availableIngredients != null)
                        {
                            @foreach (var ing in availableIngredients)
                            {
                                <MudSelectItem Value="@(ing.Id.ToString())">@ing.Name (@ing.DefaultUnit)</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="2">
                    <MudNumericField @bind-Value="ingredientQuantity" 
                                    Label="Quantity" 
                                    Required="true"
                                    Variant="Variant.Outlined"
                                    Margin="Margin.Dense"
                                    Step="0.01M"
                                    Min="0.01M" />
                </MudItem>
                <MudItem xs="12" sm="3">
                    <MudTextField @bind-Value="ingredientUnit" 
                                 Label="Unit" 
                                 Placeholder="Uses ingredient's default unit"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="3">
                    <MudTextField @bind-Value="ingredientNotes" 
                                 Label="Notes" 
                                 Placeholder="Optional notes"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense" />
                </MudItem>
            </MudGrid>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Success" 
                      OnClick="AddIngredient"
                      StartIcon="@Icons.Material.Filled.Add"
                      Size="Size.Small"
                      Class="mt-2">
                Add to Meal
            </MudButton>
        </MudPaper>

        <MudStack Row="true" Class="mt-4">
            @if (editingMeal == null)
            {
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          OnClick="CreateMeal"
                          StartIcon="@Icons.Material.Filled.RestaurantMenu">
                    Create Meal
                </MudButton>
            }
            else
            {
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          OnClick="UpdateMeal"
                          StartIcon="@Icons.Material.Filled.Save">
                    Update Meal
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Secondary" 
                          OnClick="CancelEdit">
                    Cancel
                </MudButton>
            }
        </MudStack>
    </MudPaper>

    <MudText Typo="Typo.h5" GutterBottom="true" Class="mt-6">All Meals</MudText>
    
    @if (meals == null)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (!meals.Any())
    {
        <MudAlert Severity="Severity.Info">No meals yet. Create your first meal above!</MudAlert>
    }
    else
    {
        <MudTable Items="@meals" 
                  Hover="true" 
                  Striped="true" 
                  Dense="true"
                  Elevation="2">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Cuisine</MudTh>
                <MudTh>Ingredients</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                @{
                    var meal = context;
                }
                <MudTd DataLabel="Name">
                    <MudText Typo="Typo.body2"><strong>@meal.Name</strong></MudText>
                </MudTd>
                <MudTd DataLabel="Description">@meal.Description</MudTd>
                <MudTd DataLabel="Cuisine">
                    @if (!string.IsNullOrEmpty(meal.CuisineType))
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@meal.CuisineType</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Ingredients">
                    @if (meal.Ingredients?.Any() ?? false)
                    {
                        <MudText Typo="Typo.body2">
                            @string.Join(", ", meal.Ingredients.Select(i => $"{i.Quantity} {i.Unit} {i.Ingredient?.Name ?? "Unknown"}"))
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary"><em>No ingredients</em></MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudTooltip Text="Edit">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                      Color="Color.Warning" 
                                      Size="Size.Small"
                                      OnClick="@(() => EditMeal(meal))" />
                    </MudTooltip>
                    <MudTooltip Text="Delete">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                      Color="Color.Error" 
                                      Size="Size.Small"
                                      OnClick="@(() => DeleteMeal(meal.Id))" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudContainer>

@code {
    private List<Meal>? meals;
    private List<Ingredient>? availableIngredients;
    private Meal? editingMeal;
    
    private string mealName = string.Empty;
    private string mealDescription = string.Empty;
    private string mealCuisineType = string.Empty;
    private List<MealIngredientDto> mealIngredients = new();
    
    private string selectedIngredientId = string.Empty;
    private decimal ingredientQuantity = 0;
    private string ingredientUnit = string.Empty;
    private string ingredientNotes = string.Empty;
    
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        
        // Get current user
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.Identity.Name ?? user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;
        }
    }

    private async Task LoadData()
    {
        meals = await MealService.GetAllAsync();
        availableIngredients = await IngredientService.GetAllAsync();
    }

    private void AddIngredient()
    {
        if (string.IsNullOrWhiteSpace(selectedIngredientId))
        {
            Snackbar.Add("Please select an ingredient.", Severity.Error);
            return;
        }

        if (ingredientQuantity <= 0)
        {
            Snackbar.Add("Quantity must be greater than 0.", Severity.Error);
            return;
        }

        var ingredient = availableIngredients?.FirstOrDefault(i => i.Id.ToString() == selectedIngredientId);
        if (ingredient == null)
        {
            Snackbar.Add("Selected ingredient not found.", Severity.Error);
            return;
        }

        var unit = string.IsNullOrWhiteSpace(ingredientUnit) ? ingredient.DefaultUnit : ingredientUnit;

        mealIngredients.Add(new MealIngredientDto
        {
            IngredientId = ingredient.Id,
            IngredientName = ingredient.Name,
            Quantity = ingredientQuantity,
            Unit = unit ?? string.Empty,
            Notes = ingredientNotes
        });

        // Clear ingredient form
        selectedIngredientId = string.Empty;
        ingredientQuantity = 0;
        ingredientUnit = string.Empty;
        ingredientNotes = string.Empty;
        
        Snackbar.Add($"Added {ingredient.Name} to meal", Severity.Success);
    }

    private void RemoveMealIngredient(MealIngredientDto mi)
    {
        mealIngredients.Remove(mi);
        Snackbar.Add($"Removed {mi.IngredientName}", Severity.Info);
    }

    private async Task CreateMeal()
    {
        if (string.IsNullOrWhiteSpace(mealName))
        {
            Snackbar.Add("Meal name is required.", Severity.Error);
            return;
        }

        if (!mealIngredients.Any())
        {
            Snackbar.Add("Please add at least one ingredient to the meal.", Severity.Error);
            return;
        }

        var meal = new Meal
        {
            Name = mealName.Trim(),
            Description = string.IsNullOrWhiteSpace(mealDescription) ? null : mealDescription.Trim(),
            CuisineType = string.IsNullOrWhiteSpace(mealCuisineType) ? null : mealCuisineType.Trim(),
            AuthorId = currentUserId,
            Ingredients = mealIngredients.Select(mi => new MealIngredient
            {
                IngredientId = mi.IngredientId,
                Quantity = mi.Quantity,
                Unit = mi.Unit,
                Notes = string.IsNullOrWhiteSpace(mi.Notes) ? null : mi.Notes.Trim()
            }).ToList()
        };

        await MealService.CreateAsync(meal);
        Snackbar.Add($"Meal '{meal.Name}' created successfully!", Severity.Success);
        ClearForm();
        await LoadData();
    }

    private async Task UpdateMeal()
    {
        if (editingMeal == null) return;

        if (string.IsNullOrWhiteSpace(mealName))
        {
            Snackbar.Add("Meal name is required.", Severity.Error);
            return;
        }

        if (!mealIngredients.Any())
        {
            Snackbar.Add("Please add at least one ingredient to the meal.", Severity.Error);
            return;
        }

        editingMeal.Name = mealName.Trim();
        editingMeal.Description = string.IsNullOrWhiteSpace(mealDescription) ? null : mealDescription.Trim();
        editingMeal.CuisineType = string.IsNullOrWhiteSpace(mealCuisineType) ? null : mealCuisineType.Trim();
        editingMeal.Ingredients = mealIngredients.Select(mi => new MealIngredient
        {
            IngredientId = mi.IngredientId,
            Quantity = mi.Quantity,
            Unit = mi.Unit,
            Notes = string.IsNullOrWhiteSpace(mi.Notes) ? null : mi.Notes.Trim()
        }).ToList();

        await MealService.UpdateAsync(editingMeal);
        Snackbar.Add($"Meal '{editingMeal.Name}' updated successfully!", Severity.Success);
        ClearForm();
        await LoadData();
    }

    private async Task EditMeal(Meal meal)
    {
        editingMeal = meal;
        mealName = meal.Name;
        mealDescription = meal.Description ?? string.Empty;
        mealCuisineType = meal.CuisineType ?? string.Empty;
        
        // Load the meal with ingredients
        var fullMeal = await MealService.GetByIdAsync(meal.Id);
        if (fullMeal != null && fullMeal.Ingredients != null)
        {
            mealIngredients = fullMeal.Ingredients.Select(mi => new MealIngredientDto
            {
                IngredientId = mi.IngredientId,
                IngredientName = mi.Ingredient?.Name ?? "Unknown",
                Quantity = mi.Quantity,
                Unit = mi.Unit ?? string.Empty,
                Notes = mi.Notes ?? string.Empty
            }).ToList();
        }
    }

    private void CancelEdit()
    {
        ClearForm();
    }

    private async Task DeleteMeal(Guid id)
    {
        await MealService.DeleteAsync(id);
        Snackbar.Add("Meal deleted successfully!", Severity.Info);
        await LoadData();
    }

    private void ClearForm()
    {
        editingMeal = null;
        mealName = string.Empty;
        mealDescription = string.Empty;
        mealCuisineType = string.Empty;
        mealIngredients.Clear();
        selectedIngredientId = string.Empty;
        ingredientQuantity = 0;
        ingredientUnit = string.Empty;
        ingredientNotes = string.Empty;
    }

    // DTO for managing ingredients in the UI
    private class MealIngredientDto
    {
        public Guid IngredientId { get; set; }
        public string IngredientName { get; set; } = string.Empty;
        public decimal Quantity { get; set; }
        public string Unit { get; set; } = string.Empty;
        public string Notes { get; set; } = string.Empty;
    }
}
