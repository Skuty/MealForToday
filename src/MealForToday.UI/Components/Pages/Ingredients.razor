@page "/ingredients"
@rendermode InteractiveServer
@using MealForToday.Application.Models
@inject MealForToday.Application.Services.IIngredientService IngredientService
@inject ISnackbar Snackbar

<PageTitle>Ingredients</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h3" GutterBottom="true">Ingredients Management</MudText>
    <MudText Typo="Typo.body1" Class="mb-4">Manage your ingredient library for meal planning</MudText>

    @if (!isFormExpanded && editingIngredient == null)
    {
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   OnClick="@(() => isFormExpanded = true)"
                   StartIcon="@Icons.Material.Filled.Add"
                   Class="mb-4">
            Add New Ingredient
        </MudButton>
    }

    @if (isFormExpanded || editingIngredient != null)
    {
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudText Typo="Typo.h5" GutterBottom="true">
                @(editingIngredient == null ? "Add New Ingredient" : "Edit Ingredient")
            </MudText>
            
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="ingredientName" 
                                  Label="Name" 
                                  Required="true"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="ingredientCategory" 
                                  Label="Category" 
                                  Placeholder="e.g., Vegetable, Protein, Dairy"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="ingredientDescription" 
                                  Label="Description" 
                                  Lines="2"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="ingredientDefaultUnit" 
                               Label="Default Measurement Unit" 
                               Required="true"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense">
                        <MudSelectItem Value="@("g")">g (grams)</MudSelectItem>
                        <MudSelectItem Value="@("kg")">kg (kilograms)</MudSelectItem>
                        <MudSelectItem Value="@("ml")">ml (milliliters)</MudSelectItem>
                        <MudSelectItem Value="@("l")">l (liters)</MudSelectItem>
                        <MudSelectItem Value="@("tbsp")">tbsp (tablespoon)</MudSelectItem>
                        <MudSelectItem Value="@("tsp")">tsp (teaspoon)</MudSelectItem>
                        <MudSelectItem Value="@("cup")">cup</MudSelectItem>
                        <MudSelectItem Value="@("piece")">piece</MudSelectItem>
                        <MudSelectItem Value="@("oz")">oz (ounce)</MudSelectItem>
                        <MudSelectItem Value="@("lb")">lb (pound)</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="ingredientCalories" 
                                    Label="Calories per 100g (optional)" 
                                    Variant="Variant.Outlined"
                                    Margin="Margin.Dense"
                                    Step="0.01M" />
                </MudItem>
            </MudGrid>

            <MudStack Row="true" Class="mt-4">
                @if (editingIngredient == null)
                {
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              OnClick="CreateIngredient"
                              StartIcon="@Icons.Material.Filled.Add">
                        Add Ingredient
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Secondary" 
                              OnClick="@(() => { ClearForm(); })">
                        Cancel
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              OnClick="UpdateIngredient"
                              StartIcon="@Icons.Material.Filled.Save">
                        Update Ingredient
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Secondary" 
                              OnClick="CancelEdit">
                        Cancel
                    </MudButton>
                }
            </MudStack>
        </MudPaper>
    }

    <MudText Typo="Typo.h5" GutterBottom="true" Class="mt-6">All Ingredients</MudText>
    
    @if (ingredients == null)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (!ingredients.Any())
    {
        <MudAlert Severity="Severity.Info">No ingredients yet. Add your first ingredient above!</MudAlert>
    }
    else
    {
        <MudTable Items="@ingredients" 
                  Hover="true" 
                  Striped="true" 
                  Dense="true"
                  Elevation="2">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Category</MudTh>
                <MudTh>Default Unit</MudTh>
                <MudTh>Calories/100g</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                @{
                    var ingredient = context;
                }
                <MudTd DataLabel="Name">
                    <MudText Typo="Typo.body2"><strong>@ingredient.Name</strong></MudText>
                </MudTd>
                <MudTd DataLabel="Description">@ingredient.Description</MudTd>
                <MudTd DataLabel="Category">
                    @if (!string.IsNullOrEmpty(ingredient.Category))
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">@ingredient.Category</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Default Unit">@ingredient.DefaultUnit</MudTd>
                <MudTd DataLabel="Calories/100g">@(ingredient.CaloriesPer100g?.ToString("F2") ?? "-")</MudTd>
                <MudTd DataLabel="Actions">
                    <MudTooltip Text="Edit">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                      Color="Color.Warning" 
                                      Size="Size.Small"
                                      OnClick="@(() => EditIngredient(ingredient))" />
                    </MudTooltip>
                    <MudTooltip Text="Delete">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                      Color="Color.Error" 
                                      Size="Size.Small"
                                      OnClick="@(() => DeleteIngredient(ingredient.Id))" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudContainer>

@code {
    private List<Ingredient>? ingredients;
    private Ingredient? editingIngredient;
    private string ingredientName = string.Empty;
    private string ingredientDescription = string.Empty;
    private string ingredientCategory = string.Empty;
    private string ingredientDefaultUnit = "g"; // Default to grams
    private decimal? ingredientCalories;
    private bool isFormExpanded = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadIngredients();
    }

    private async Task LoadIngredients()
    {
        ingredients = await IngredientService.GetAllAsync();
    }

    private async Task CreateIngredient()
    {
        if (string.IsNullOrWhiteSpace(ingredientName))
        {
            Snackbar.Add("Name is required.", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(ingredientDefaultUnit))
        {
            Snackbar.Add("Default measurement unit is required.", Severity.Error);
            return;
        }

        var ingredient = new Ingredient
        {
            Name = ingredientName.Trim(),
            Description = string.IsNullOrWhiteSpace(ingredientDescription) ? null : ingredientDescription.Trim(),
            Category = string.IsNullOrWhiteSpace(ingredientCategory) ? null : ingredientCategory.Trim(),
            DefaultUnit = ingredientDefaultUnit,
            CaloriesPer100g = ingredientCalories,
            IsStandard = true
        };

        await IngredientService.CreateAsync(ingredient);
        Snackbar.Add($"Ingredient '{ingredient.Name}' added successfully!", Severity.Success);
        ClearForm();
        await LoadIngredients();
    }

    private async Task UpdateIngredient()
    {
        if (editingIngredient == null) return;

        if (string.IsNullOrWhiteSpace(ingredientName))
        {
            Snackbar.Add("Name is required.", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(ingredientDefaultUnit))
        {
            Snackbar.Add("Default measurement unit is required.", Severity.Error);
            return;
        }

        editingIngredient.Name = ingredientName.Trim();
        editingIngredient.Description = string.IsNullOrWhiteSpace(ingredientDescription) ? null : ingredientDescription.Trim();
        editingIngredient.Category = string.IsNullOrWhiteSpace(ingredientCategory) ? null : ingredientCategory.Trim();
        editingIngredient.DefaultUnit = ingredientDefaultUnit;
        editingIngredient.CaloriesPer100g = ingredientCalories;

        await IngredientService.UpdateAsync(editingIngredient);
        Snackbar.Add($"Ingredient '{editingIngredient.Name}' updated successfully!", Severity.Success);
        ClearForm();
        await LoadIngredients();
    }

    private void EditIngredient(Ingredient ingredient)
    {
        editingIngredient = ingredient;
        ingredientName = ingredient.Name;
        ingredientDescription = ingredient.Description ?? string.Empty;
        ingredientCategory = ingredient.Category ?? string.Empty;
        ingredientDefaultUnit = ingredient.DefaultUnit ?? "g";
        ingredientCalories = ingredient.CaloriesPer100g;
        isFormExpanded = true; // Expand form when editing
    }

    private void CancelEdit()
    {
        ClearForm();
    }

    private async Task DeleteIngredient(Guid id)
    {
        await IngredientService.DeleteAsync(id);
        Snackbar.Add("Ingredient deleted successfully!", Severity.Info);
        await LoadIngredients();
    }

    private void ClearForm()
    {
        editingIngredient = null;
        ingredientName = string.Empty;
        ingredientDescription = string.Empty;
        ingredientCategory = string.Empty;
        ingredientDefaultUnit = "g"; // Reset to default
        ingredientCalories = null;
        isFormExpanded = false; // Collapse form after clearing
    }
}
